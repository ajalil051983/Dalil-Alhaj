using Mapsui;
using Mapsui.Layers;
using Mapsui.Nts;
using Mapsui.Projections;
using Mapsui.Styles;
using Mapsui.Tiling;
using Mapsui.UI.Maui;
using Mapsui.Widgets;
using NetTopologySuite.Geometries;

namespace DalilAlHaj.Pages
{
    public partial class MapPage : ContentPage
    {
        private ILayer? userLocationLayer;

        public MapPage()
        {
            InitializeComponent();
            FlowDirection = Services.LocalizationService.GetFlowDirection();
            InitializeMap();
            RequestLocationPermissionAndShowUserLocation();
        }

        private void InitializeMap()
        {
            // Create the map
            var map = new Mapsui.Map();

            // Add OpenStreetMap tile layer (no API key required!)
            map.Layers.Add(OpenStreetMap.CreateTileLayer());

            // Add Hajj route line layer
            var routeLayer = CreateRouteLayer();
            map.Layers.Add(routeLayer);

            // Add Hajj location pins
            var pinLayer = CreatePinLayer();
            map.Layers.Add(pinLayer);

            // Hide attribution widgets (top-left and bottom-right info boxes)
            map.Widgets.Clear();

            // Assign map to control
            HajjMapControl.Map = map;

            // Center on Kaaba after map is loaded
            MainThread.BeginInvokeOnMainThread(async () =>
            {
                await Task.Delay(500); // Wait for map to initialize
                var kaabaLocation = SphericalMercator.FromLonLat(39.8262, 21.4225);
                var mPoint = new MPoint(kaabaLocation.x, kaabaLocation.y);
                HajjMapControl.Map?.Navigator.CenterOn(mPoint);
                HajjMapControl.Map?.Navigator.ZoomTo(12); // Zoom level
            });
        }

        private MemoryLayer CreateRouteLayer()
        {
            // Define Hajj route sequence (Kaaba -> Mina -> Arafat -> Muzdalifah -> Mina -> Kaaba)
            var routePoints = new[]
            {
                new { Lat = 21.4225, Lon = 39.8262 }, // Kaaba
                new { Lat = 21.4219, Lon = 39.8926 }, // Mina
                new { Lat = 21.3547, Lon = 39.9839 }, // Arafat
                new { Lat = 21.4069, Lon = 39.9375 }, // Muzdalifah
                new { Lat = 21.4219, Lon = 39.8926 }, // Mina (return)
                new { Lat = 21.4225, Lon = 39.8262 }  // Kaaba (return for Tawaf)
            };

            // Convert to map coordinates
            var coordinates = routePoints
                .Select(p => SphericalMercator.FromLonLat(p.Lon, p.Lat))
                .Select(coord => new Coordinate(coord.x, coord.y))
                .ToArray();

            // Create line string
            var lineString = new LineString(coordinates);

            // Create feature
            var feature = new GeometryFeature
            {
                Geometry = lineString
            };

            // Create line style
            feature.Styles.Add(new VectorStyle
            {
                Line = new Pen(Mapsui.Styles.Color.FromString("#E74C3C"), 4)
                {
                    PenStyle = PenStyle.Solid,
                    PenStrokeCap = PenStrokeCap.Round
                }
            });

            // Create memory layer
            var layer = new MemoryLayer
            {
                Name = "Hajj Route",
                Features = new[] { feature },
                Style = null
            };

            return layer;
        }

        private MemoryLayer CreatePinLayer()
        {
            var features = new List<IFeature>();

            // Define Hajj locations with colors
            var locations = new[]
            {
                new { Name = DalilAlHaj.Resources.Localization.AppResources.Kaaba, Lat = 21.4225, Lon = 39.8262, Color = "#E74C3C" },
                new { Name = DalilAlHaj.Resources.Localization.AppResources.Arafat, Lat = 21.3547, Lon = 39.9839, Color = "#3498DB" },
                new { Name = DalilAlHaj.Resources.Localization.AppResources.Muzdalifah, Lat = 21.4069, Lon = 39.9375, Color = "#9B59B6" },
                new { Name = DalilAlHaj.Resources.Localization.AppResources.Mina, Lat = 21.413052539985806, Lon = 39.89021580688235, Color = "#27AE60" },
                new { Name = DalilAlHaj.Resources.Localization.AppResources.SafaMarwa, Lat = 21.4233, Lon = 39.8266, Color = "#F39C12" }
            };

            foreach (var location in locations)
            {
                // Convert lat/lon to map coordinates
                var point = SphericalMercator.FromLonLat(location.Lon, location.Lat);
                
                // Create feature
                var feature = new GeometryFeature
                {
                    Geometry = new NetTopologySuite.Geometries.Point(point.x, point.y)
                };

                // Add label data
                feature["Label"] = location.Name;

                // Create pin style with color
                feature.Styles.Add(new SymbolStyle
                {
                    SymbolScale = 1.0,
                    Fill = new Mapsui.Styles.Brush(Mapsui.Styles.Color.FromString(location.Color)),
                    Outline = new Pen(Mapsui.Styles.Color.White, 3),
                    SymbolType = SymbolType.Ellipse
                });

                // Add label style
                feature.Styles.Add(new LabelStyle
                {
                    Text = location.Name,
                    BackColor = new Mapsui.Styles.Brush(Mapsui.Styles.Color.FromArgb(230, 255, 255, 255)),
                    ForeColor = Mapsui.Styles.Color.Black,
                    Halo = new Pen(Mapsui.Styles.Color.White, 2),
                    Font = new Mapsui.Styles.Font { FontFamily = "Arial", Size = 11, Bold = true },
                    Offset = new Offset(0, -25),
                    HorizontalAlignment = LabelStyle.HorizontalAlignmentEnum.Center
                });

                features.Add(feature);
            }

            // Create memory layer
            var layer = new MemoryLayer
            {
                Name = "Hajj Locations",
                Features = features,
                Style = null
            };

            return layer;
        }

        private async void RequestLocationPermissionAndShowUserLocation()
        {
            try
            {
                var status = await Permissions.CheckStatusAsync<Permissions.LocationWhenInUse>();
                
                if (status != PermissionStatus.Granted)
                {
                    status = await Permissions.RequestAsync<Permissions.LocationWhenInUse>();
                }

                if (status == PermissionStatus.Granted)
                {
                    await ShowUserLocation();
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Location permission error: {ex.Message}");
            }
        }

        private async Task ShowUserLocation()
        {
            try
            {
                var location = await Geolocation.GetLocationAsync(new GeolocationRequest
                {
                    DesiredAccuracy = GeolocationAccuracy.Medium,
                    Timeout = TimeSpan.FromSeconds(10)
                });

                if (location != null)
                {
                    // Remove existing user location layer if any
                    if (userLocationLayer != null && HajjMapControl.Map?.Layers.Contains(userLocationLayer) == true)
                    {
                        HajjMapControl.Map.Layers.Remove(userLocationLayer);
                    }

                    // Create user location layer
                    userLocationLayer = CreateUserLocationLayer(location.Latitude, location.Longitude);
                    HajjMapControl.Map?.Layers.Add(userLocationLayer);

                    // Refresh map
                    HajjMapControl.Map?.Refresh();
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Location error: {ex.Message}");
            }
        }

        private MemoryLayer CreateUserLocationLayer(double lat, double lon)
        {
            // Convert lat/lon to map coordinates
            var point = SphericalMercator.FromLonLat(lon, lat);

            // Create feature
            var feature = new GeometryFeature
            {
                Geometry = new NetTopologySuite.Geometries.Point(point.x, point.y)
            };

            // Create user position style (blue dot with white border)
            feature.Styles.Add(new SymbolStyle
            {
                SymbolScale = 1.2,
                Fill = new Mapsui.Styles.Brush(Mapsui.Styles.Color.FromString("#3498DB")),
                Outline = new Pen(Mapsui.Styles.Color.White, 4),
                SymbolType = SymbolType.Ellipse
            });

            // Add label
            feature.Styles.Add(new LabelStyle
            {
                Text = DalilAlHaj.Resources.Localization.AppResources.YourLocation,
                BackColor = new Mapsui.Styles.Brush(Mapsui.Styles.Color.FromArgb(230, 52, 152, 219)),
                ForeColor = Mapsui.Styles.Color.White,
                Font = new Mapsui.Styles.Font { FontFamily = "Arial", Size = 11, Bold = true },
                Offset = new Offset(0, -30),
                HorizontalAlignment = LabelStyle.HorizontalAlignmentEnum.Center
            });

            // Create memory layer
            var layer = new MemoryLayer
            {
                Name = "User Location",
                Features = new[] { feature },
                Style = null
            };

            return layer;
        }
    }
}
