using Mapsui;
using Mapsui.Extensions;
using Mapsui.Layers;
using Mapsui.Nts;
using Mapsui.Projections;
using Mapsui.Styles;
using Mapsui.Tiling;
using Mapsui.UI.Maui;
using Mapsui.Widgets;
using NetTopologySuite.Geometries;
using SkiaSharp;
using Svg.Skia;
using System.Reflection;

namespace DalilAlHaj.Pages
{
    public partial class MapPage : ContentPage
    {
        private ILayer? userLocationLayer;

        public MapPage()
        {
            InitializeComponent();
            FlowDirection = Services.LocalizationService.GetFlowDirection();
            InitializeMap();
            RequestLocationPermissionAndShowUserLocation();
        }

        private void InitializeMap()
        {
            // Create the map
            var map = new Mapsui.Map();

            // Add OpenStreetMap tile layer (no API key required!)
            map.Layers.Add(OpenStreetMap.CreateTileLayer());

            // Add Hajj route line layer
            var routeLayer = CreateRouteLayer();
            map.Layers.Add(routeLayer);

            // Add Hajj location pins
            var pinLayer = CreatePinLayer();
            map.Layers.Add(pinLayer);

            // Hide attribution widgets (top-left and bottom-right info boxes)
            map.Widgets.Clear();

            // Assign map to control
            HajjMapControl.Map = map;

            // Center on Kaaba after map is loaded
            MainThread.BeginInvokeOnMainThread(async () =>
            {
                await Task.Delay(500); // Wait for map to initialize
                var kaabaLocation = SphericalMercator.FromLonLat(39.8262, 21.4225);
                var mPoint = new MPoint(kaabaLocation.x, kaabaLocation.y);
                HajjMapControl.Map?.Navigator.CenterOn(mPoint);
                HajjMapControl.Map?.Navigator.ZoomTo(12); // Zoom level
            });
        }

        private MemoryLayer CreateRouteLayer()
        {
            // Define Hajj route sequence (Kaaba -> Mina -> Arafat -> Muzdalifah -> Mina -> Kaaba)
            var routePoints = new[]
            {
                new { Lat = 21.4225, Lon = 39.8262 }, // Kaaba
                new { Lat = 21.4219, Lon = 39.8926 }, // Mina
                new { Lat = 21.3547, Lon = 39.9839 }, // Arafat
                new { Lat = 21.4069, Lon = 39.9375 }, // Muzdalifah
                new { Lat = 21.4219, Lon = 39.8926 }, // Mina (return)
                new { Lat = 21.4225, Lon = 39.8262 }  // Kaaba (return for Tawaf)
            };

            // Convert to map coordinates
            var coordinates = routePoints
                .Select(p => SphericalMercator.FromLonLat(p.Lon, p.Lat))
                .Select(coord => new Coordinate(coord.x, coord.y))
                .ToArray();

            // Create line string
            var lineString = new LineString(coordinates);

            // Create feature
            var feature = new GeometryFeature
            {
                Geometry = lineString
            };

            // Create line style
            feature.Styles.Add(new VectorStyle
            {
                Line = new Pen(Mapsui.Styles.Color.FromString("#E74C3C"), 5)
                {
                    PenStyle = PenStyle.Solid,
                    PenStrokeCap = PenStrokeCap.Round
                }
            });

            // Create memory layer
            var layer = new MemoryLayer
            {
                Name = "Hajj Route",
                Features = new[] { feature },
                Style = null
            };

            return layer;
        }

        private MemoryLayer CreatePinLayer()
        {
            // Define Hajj locations with SVG pins
            var locations = new[]
            {
                new { Name = DalilAlHaj.Resources.Localization.AppResources.Kaaba, Lat = 21.4225, Lon = 39.8262, PinImage = "pin_red.svg" },
                new { Name = DalilAlHaj.Resources.Localization.AppResources.Arafat, Lat = 21.3547, Lon = 39.9839, PinImage = "pin_blue.svg" },
                new { Name = DalilAlHaj.Resources.Localization.AppResources.Muzdalifah, Lat = 21.4069, Lon = 39.9375, PinImage = "pin_purple.svg" },
                new { Name = DalilAlHaj.Resources.Localization.AppResources.Mina, Lat = 21.413052539985806, Lon = 39.89021580688235, PinImage = "pin_green.svg" },
                new { Name = DalilAlHaj.Resources.Localization.AppResources.SafaMarwa, Lat = 21.4233, Lon = 39.8266, PinImage = "pin_orange.svg" }
            };

            var features = locations.Select(location =>
            {
                var point = SphericalMercator.FromLonLat(location.Lon, location.Lat);
                var feature = new PointFeature(point.ToMPoint());
                feature["name"] = location.Name;
                
                // Add individual pin style with SVG image converted to bitmap
                feature.Styles.Add(CreatePinStyleFromSvg(location.PinImage, location.Name));
                
                return feature;
            }).ToArray();

            return new MemoryLayer
            {
                Name = "Hajj Locations",
                Features = features,
                Style = null // Each feature has its own style
            };
        }

        private static IStyle CreatePinStyleFromSvg(string pinImageFileName, string locationName)
        {
            System.Diagnostics.Debug.WriteLine($"Creating pin style for {locationName} with image: {pinImageFileName}");
            
            try
            {
                // Load SVG and convert to Mapsui.Styles.Image
                var bitmapId = LoadSvgAsBitmapId(pinImageFileName);
                
                return new SymbolStyle
                {
                    BitmapId = bitmapId,
                    SymbolScale = 0.8,
                    RelativeOffset = new RelativeOffset(0.0, 0.5)
                };
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Error loading SVG {pinImageFileName}: {ex.Message}");
                
                // Fallback to simple circle if SVG fails to load
                return new SymbolStyle
                {
                    SymbolScale = 0.5,
                    Fill = new Mapsui.Styles.Brush(Mapsui.Styles.Color.Red)
                };
            }
        }

        private static int LoadSvgAsBitmapId(string svgFileName)
        {
            // Load SVG from embedded resource
            var assembly = Assembly.GetExecutingAssembly();
            var resourceName = $"DalilAlHaj.Resources.Images.{svgFileName}";
            
            using var stream = assembly.GetManifestResourceStream(resourceName);
            if (stream == null)
            {
                throw new FileNotFoundException($"SVG resource not found: {resourceName}");
            }

            // Load SVG using Svg.Skia
            var svg = new SKSvg();
            var picture = svg.Load(stream);

            if (picture == null)
            {
                throw new InvalidOperationException($"Failed to load SVG: {svgFileName}");
            }

            // Define target size for the bitmap
            var targetWidth = 64;
            var targetHeight = 88;

            // Create bitmap from SVG
            var imageInfo = new SKImageInfo(targetWidth, targetHeight, SKColorType.Rgba8888, SKAlphaType.Premul);
            using var surface = SKSurface.Create(imageInfo);
            var canvas = surface.Canvas;
            canvas.Clear(SKColors.Transparent);

            // Scale SVG to fit target size
            var svgWidth = picture.CullRect.Width;
            var svgHeight = picture.CullRect.Height;
            var scaleX = targetWidth / svgWidth;
            var scaleY = targetHeight / svgHeight;
            var scale = Math.Min(scaleX, scaleY);

            var matrix = SKMatrix.CreateScale(scale, scale);
            canvas.DrawPicture(picture, ref matrix);
            canvas.Flush();

            // Convert to bytes and register with BitmapRegistry
            using var image = surface.Snapshot();
            using var data = image.Encode(SKEncodedImageFormat.Png, 100);
            var bytes = data.ToArray();

            // Register with BitmapRegistry and return ID
            return Mapsui.Rendering.Skia.SkiaBitmapRegistry.Instance.Register(new MemoryStream(bytes));
        }

        private async void RequestLocationPermissionAndShowUserLocation()
        {
            try
            {
                var status = await Permissions.CheckStatusAsync<Permissions.LocationWhenInUse>();
                
                if (status != PermissionStatus.Granted)
                {
                    status = await Permissions.RequestAsync<Permissions.LocationWhenInUse>();
                }

                if (status == PermissionStatus.Granted)
                {
                    await ShowUserLocation();
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Location permission error: {ex.Message}");
            }
        }

        private async Task ShowUserLocation()
        {
            try
            {
                var location = await Geolocation.GetLocationAsync(new GeolocationRequest
                {
                    DesiredAccuracy = GeolocationAccuracy.Medium,
                    Timeout = TimeSpan.FromSeconds(10)
                });

                if (location != null)
                {
                    // Remove existing user location layer if any
                    if (userLocationLayer != null && HajjMapControl.Map?.Layers.Contains(userLocationLayer) == true)
                    {
                        HajjMapControl.Map.Layers.Remove(userLocationLayer);
                    }

                    // Create user location layer
                    userLocationLayer = CreateUserLocationLayer(location.Latitude, location.Longitude);
                    HajjMapControl.Map?.Layers.Add(userLocationLayer);

                    // Refresh map
                    HajjMapControl.Map?.Refresh();
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Location error: {ex.Message}");
            }
        }

        private MemoryLayer CreateUserLocationLayer(double lat, double lon)
        {
            // Convert lat/lon to map coordinates
            var point = SphericalMercator.FromLonLat(lon, lat);

            // Create feature using PointFeature
            var feature = new PointFeature(point.ToMPoint());
            feature["name"] = DalilAlHaj.Resources.Localization.AppResources.YourLocation;

            // Use special blue pin for current location
            try
            {
                var bitmapId = LoadSvgAsBitmapId("pin_location.svg");
                feature.Styles.Add(new SymbolStyle
                {
                    BitmapId = bitmapId,
                    SymbolScale = 1.0,
                    RelativeOffset = new RelativeOffset(0.0, 0.5)
                });
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Error loading user location pin: {ex.Message}");
                // Fallback style
                feature.Styles.Add(new SymbolStyle
                {
                    SymbolScale = 0.5,
                    Fill = new Mapsui.Styles.Brush(Mapsui.Styles.Color.Blue)
                });
            }

            // Create memory layer
            return new MemoryLayer
            {
                Name = "User Location",
                Features = new[] { feature },
                Style = null
            };
        }
    }
}
